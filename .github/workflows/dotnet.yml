# Genpact Automation: Run Playwright tests, upload Allure results, deploy report to GitHub Pages.
# For branch-based Pages: Settings > Pages > Source: Deploy from branch > gh-pages.

name: Playwright Full-Stack Tests

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - 'README.md'
  pull_request:
    branches: [ main, master ]
    paths-ignore:
      - 'README.md'
  workflow_dispatch:

jobs:
  test:
    name: Run QA Tests
    timeout-minutes: 30
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 7
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 7.0.x

      - name: Restore and Build
        run: dotnet restore && dotnet build --no-restore

      - name: Install Playwright browsers
        run: pwsh GenpactAutomation/bin/Debug/net7.0/playwright.ps1 install --with-deps

      - name: Run Playwright tests
        run: xvfb-run dotnet test --no-restore --no-build
        # Allure.NUnit writes to GenpactAutomation/bin/Debug/net7.0/allure-results/

      - name: Upload Allure results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-results
          path: GenpactAutomation/bin/Debug/net7.0/allure-results/
          retention-days: 3

  deploy-report:
    name: Deploy Allure Report to Pages
    if: always()
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Allure results
        uses: actions/download-artifact@v4
        with:
          name: allure-results
          path: allure-results

      - name: Install Allure CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y default-jre unzip wget
          wget https://github.com/allure-framework/allure2/releases/download/2.35.1/allure-2.35.1.zip
          unzip -q allure-2.35.1.zip -d /opt/allure
          sudo ln -sf /opt/allure/allure-2.35.1/bin/allure /usr/bin/allure

      - name: Restore history from gh-pages
        run: |
          git fetch origin gh-pages 2>/dev/null || true
          if git ls-tree -r origin/gh-pages --name-only 2>/dev/null | grep -q "^history/"; then
            git checkout origin/gh-pages -- history 2>/dev/null || true
            mkdir -p allure-results/history
            cp -r history/* allure-results/history/ 2>/dev/null || true
          fi

      - name: Generate Allure Report
        run: allure generate allure-results --clean -o allure-report

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report
          publish_branch: gh-pages

      - name: Comment PR with Allure Report link
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const [owner, repo] = '${{ github.repository }}'.split('/');
            const reportUrl = `https://${owner}.github.io/${repo}/`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `**Allure Report is ready!**\n\n${reportUrl}`
            });

      - name: Add Action Summary
        run: |
          REPO="${{ github.repository }}"
          OWNER="${REPO%%/*}"
          NAME="${REPO#*/}"
          echo "## Allure Report" >> $GITHUB_STEP_SUMMARY
          echo "**https://${OWNER}.github.io/${NAME}/**" >> $GITHUB_STEP_SUMMARY
